---
title: "Bootstrap Optimism Correction"
author: Tingting Zhan
date: "`r Sys.Date()`"
format: 
  html:
    page-layout: full
    html-math-method: katex
number-sections: true
toc: true
toc-location: left
toc-depth: 4
toc-title: ''
editor: source
bibliography: boc.bib
knitr:
  opts_chunk: 
    collapse: true
    comment: "#" 
vignette: >
  %\VignetteIndexEntry{intro}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

# Introduction

This vignette provides examples of using `R` packages

-   **`maxEff`**, @maxEff, [CRAN](https://cran.r-project.org/package=maxEff), [Github](https://github.com/tingtingzhan/maxEff), [RPubs](https://rpubs.com/tingtingzhan/maxEff)
-   **`boc`**, [Github](https://github.com/tingtingzhan/boc), [RPubs](https://rpubs.com/tingtingzhan/boc) <!--
                        -   **`boc`**, @boc, [CRAN](https://cran.r-project.org/package=groupedHyperframe), [Github](https://github.com/tingtingzhan/groupedHyperframe), [RPubs](https://rpubs.com/tingtingzhan/groupedHyperframe)
                        -->

to ....

R terminology might be different from that of mathematics and statistics. Please refer to Appendix @sec-terms for explanation and reference of the terms and abbreviations used in this vignette.

Package **`boc`** `Imports` packages

-   **`parallel`** shipped with `r R.version$version.string`, for parallel computing
-   `r '\U1f5dd'` **`matrixStats`** [@matrixStats, v`r packageVersion('matrixStats')`], key dependency, for column-median of `matrix`
-   `r '\U1f5dd'` **`maxEff`** [@matrixStats, v`r packageVersion('maxEff')`], key dependency
-   `r '\U1f5dd'` **`rpart`** [@rpart, v`r packageVersion('rpart')`], key dependency, for recursive partitioning

Package **`boc`** `Suggests` packages

-   **`boot`** [@boot, v`r packageVersion('boot')`], for ...
-   `r '\U1f5dd'` **`survival`** [@survival, v`r packageVersion('survival')`], key suggest, <!--for function `survival:::as.data.frame.Surv()`--> to help `hyperframe` understand `Surv` object

Package **`maxEff`** dependencies are outlined in its separate vignette ([CRAN](https://cran.r-project.org/package=maxEff/vignettes/maxEff.html), [RPubs](https://rpubs.com/tingtingzhan/maxEff)).

## Prerequisite

Packages **`boc`** and **`maxEff`** require R version 4.5.0 (released 2025-04-11) or higher ([macOS](https://cran.r-project.org/bin/macosx/), [Windows](https://cran.r-project.org/bin/windows/base/)). An Integrated Development Environment (IDE), e.g., [RStudio](https://posit.co/download/rstudio-desktop/) [@RStudio] or [Positron](https://positron.posit.co/download.html), is not required, but highly recommended. This vignette is created under `r R.version$version.string` using packages **`knitr`** [@knitr, v`r packageVersion('knitr')`], **`quarto`** [@quarto, v`r packageVersion('quarto')` with [Quarto](https://quarto.org/docs/get-started/) v`r quarto::quarto_version()`] and **`rmarkdown`** [@rmarkdown, v`r packageVersion('rmarkdown')`].

```{r}
#| code-fold: true
#| code-summary: "Environment on author's computer"
Sys.info()[c('sysname', 'release', 'machine')]
R.version
```

Experimental (and maybe unstable) features are released *extremely frequently* to [Github](https://github.com/tingtingzhan/maxEff). [Active developers should use the Github version; suggestions and bug reports are welcome!]{style="background-color: #FFFF00"} Stable releases to [CRAN](https://CRAN.R-project.org/package=maxEff) are typically updated every 2 to 3 months, or when the authors have an upcoming manuscript in the peer-reviewing process.

```{r}
#| eval: false
remotes::install_github('tingtingzhan/maxEff')
remotes::install_github('tingtingzhan/boc')
```

```{r}
#| eval: false
#| code-fold: true
#| code-summary: "Developers, do NOT use the CRAN version!"
# utils::install.packages('boc') # Developers, do NOT use!!
utils::install.packages('maxEff') # Developers, do NOT use!!
```

## Getting Started

Examples in this vignette require that the `search` path has

```{r setup}
library(boc)
library(survival)
```

For the function name clash between `spatstat.explore::plot.roc()` and `pROC::plot.roc()`, see detailed explanation in package **`maxEff`** vignette ([RPubs](https://rpubs.com/tingtingzhan/maxEff), CRAN).

```{r}
#| echo: false
#options(mc.cores = 1L) # for CRAN submission
```

## Acknowledgement

This work is supported by National Institutes of Health, U.S. Department of Health and Human Services grants

-   R01CA222847 ([I. Chervoneva](https://orcid.org/0000-0002-9104-4505), [T. Zhan](https://orcid.org/0000-0001-9971-4844), and [H. Rui](https://orcid.org/0000-0002-8778-261X))
-   R01CA253977 (H. Rui and I. Chervoneva).

# Example

```{r}
data(flchain, package = 'survival')
flchain2 = flchain |> 
  subset.data.frame(subset = (futime > 0)) |> # required by ?rpart::rpart
  subset.data.frame(subset = (chapter == 'Circulatory')) |>
  within.data.frame(expr = {
    mgus = as.logical(mgus)
    OS = Surv(futime, death)
    chapter = futime = death = NULL
  })
```

```{r}
dim(flchain2) # 742
```

```{r}
m0 = coxph(OS ~ age + creatinine, data = flchain2)
```

```{r}
#| code-fold: true
#| code-summary: 'A `coxph` model *`m0`*'
m0
```

```{r}
nobs(m0) # 673, due to missingness in `creatinine`
```

# `add_dummies()`

```{r}
m1 = m0 |>
  add_dummies(formula = ~ kappa + lambda)
```

```{r}
m1
```

```{r}
m1 |>
  sapply(FUN = maxEff::get_cutoff)
```

# `boot_rule()`

```{r}
set.seed(143); m2 = m1 |>
  boot_rule(R = 30L)
```

```{r}
stopifnot(length(m2) == 30L)
```

```{r}
m2[[1L]] # rule of 1st bootstrap
```

```{r}
#| code-fold: true
#| code-summary: "Cut-off values in *`m2`*"
m2 |>
  lapply(FUN = \(i) sapply(i, FUN = maxEff::get_cutoff)) |>
  do.call(rbind, args = _)
```

# `boot_optimism()`

```{r}
set.seed(143); m3 = m1 |>
  boot_optimism(R = 30L)
```

```{r}
head(m3) # just a matrix
```

# `boc()`

```{r}
set.seed(143); m4 = m1 |>
boc(R = 30L)
```

```{r}
m4 |> 
  summary()
```

# Terms & Abbreviations {#sec-terms}

| Term / Abbreviation | Description |
|------------------------------------|------------------------------------|
| CRAN, R | The Comprehensive R Archive Network, <https://cran.r-project.org> |
| `Depends`, `Imports`, `Suggests`, `Enhances` | [*Writing R Extensions*, Section 1.1.3 *Package Dependencies*](https://cran.r-project.org/doc/manuals/r-devel/R-exts.html#Package-Dependencies) |
| [`|>`](https://search.r-project.org/R/refmans/base/html/pipeOp.html) | Forward pipe operator introduced since R 4.1.0 |
| [`::`](https://search.r-project.org/R/refmans/base/html/ns-dblcolon.html) | Explicitly-[namespace](https://search.r-project.org/R/refmans/base/html/ns-reflect.html)d function or object |
| [`addmargins`](https://search.r-project.org/R/refmans/stats/html/addmargins.html) | Add margins to [`array`](https://search.r-project.org/R/refmans/base/html/array.html)s |
| [`as.environment`](https://search.r-project.org/R/refmans/base/html/as.environment.html) | Convert an object to an environment |
| [`abs`](https://search.r-project.org/R/refmans/base/html/MathFun.html) | Absolute value |
| [`call`](https://search.r-project.org/R/refmans/base/html/call.html) | Unevaluated expression |
| [`coxph`](https://search.r-project.org/CRAN/refmans/survival/html/coxph.html) | Cox proportional hazards model |
| [`createDataPartition`](https://search.r-project.org/CRAN/refmans/caret/html/createDataPartition.html) | Test vs. training data set partition, from package **`caret`** [@caret] |
| [`duplicated`](https://search.r-project.org/R/refmans/base/html/duplicated.html) | Duplicate elements |
| [`emptyenv`](https://search.r-project.org/R/refmans/base/html/environment.html) | Empty environment |
| [`environment`](https://search.r-project.org/R/refmans/base/html/environment.html) | Environment |
| [`eval`](https://search.r-project.org/R/refmans/base/html/eval.html) | Evaluate an [`expression`](https://search.r-project.org/R/refmans/base/html/expression.html) |
| [`factor`](https://search.r-project.org/R/refmans/base/html/factor.html) | Factor, or categorical variable |
| [`formals`](https://search.r-project.org/R/refmans/base/html/formals.html) | Formal arguments |
| [`closure`, `function`](https://search.r-project.org/R/refmans/base/html/function.html) | R function |
| [`globalenv`, `.GlobalEnv`](https://search.r-project.org/R/refmans/base/html/environment.html) | Global environment |
| [`groupedHyperframe`](https://CRAN.R-project.org/package=groupedHyperframe) | Grouped hyper data frame, from package **`groupedHyperframe`** [@groupedHyperframe] |
| [`head`](https://search.r-project.org/R/refmans/utils/html/head.html) | First parts of an object |
| `hypercolumns`, [`hyperframe`](https://search.r-project.org/CRAN/refmans/spatstat.geom/html/hyperframe.html) | (Hyper columns of) hyper data frame, from package **`spatstat.geom`** [@spatstat05] |
| [`inherits`](https://search.r-project.org/R/refmans/base/html/class.html) | Class inheritance |
| [`labels`](https://search.r-project.org/R/refmans/base/html/labels.html) | Labels from object |
| [`levels`](https://search.r-project.org/R/refmans/base/html/levels.html) | Levels of a [`factor`](https://search.r-project.org/R/refmans/base/html/factor.html) |
| [`list2env`](https://search.r-project.org/R/refmans/stats/html/list2env.html) | Convert a [`list`](https://search.r-project.org/R/refmans/base/html/list.html) to [`environment`](https://search.r-project.org/R/refmans/base/html/environment.html) |
| [`listof`](https://search.r-project.org/R/refmans/stats/html/listof.html) | List of objects |
| `logistic` | Logistic regression model, `stats::glm(., family = binomial('logit'))` |
| [`matrix`](https://search.r-project.org/R/refmans/base/html/matrix.html) | Matrix |
| [`median`](https://search.r-project.org/R/refmans/stats/html/median.html) | Median value |
| [`parent.env`](https://search.r-project.org/R/refmans/base/html/environment.html) | Parent environment |
| `PFS` | Progression/recurrence free survival, <https://en.wikipedia.org/wiki/Progression-free_survival> |
| [`predict`](https://search.r-project.org/R/refmans/stats/html/predict.html) | Model prediction |
| [`quantile`](https://search.r-project.org/R/refmans/stats/html/quantile.html) | Quantile |
| [`rpart`](https://search.r-project.org/CRAN/refmans/rpart/html/rpart.html), [`rpart.object`](https://search.r-project.org/CRAN/refmans/rpart/html/rpart.object.html), `node` | Recursive partitioning and regression trees |
| `S3`, `generic`, [`methods`](https://search.r-project.org/R/refmans/utils/html/methods.html) | `S3` object oriented system, [`UseMethod`](https://search.r-project.org/R/refmans/base/html/UseMethod.html); [`getS3method`](https://search.r-project.org/R/refmans/utils/html/getS3method.html); <https://adv-r.hadley.nz/s3.html> |
| `S4`, `generic`, `methods` | `S4` object oriented system, [`isS4`](https://search.r-project.org/R/refmans/base/html/isS4.html); [`setClass`](https://search.r-project.org/R/refmans/methods/html/setClass.html); [`setMethod`](https://search.r-project.org/R/refmans/methods/html/setMethod.html); [`getMethod`](https://search.r-project.org/R/refmans/methods/html/getMethod.html); <https://adv-r.hadley.nz/s4.html> |
| [`sort_by`](https://search.r-project.org/R/refmans/base/html/sort_by.html) | Sort an object by some criterion |
| [`str2lang`](https://search.r-project.org/R/refmans/base/html/str2lang.html) | To [`parse`](https://search.r-project.org/R/refmans/base/html/parse.html) R [`expression`](https://search.r-project.org/R/refmans/base/html/expression.html)s |
| [`subset`](https://search.r-project.org/R/refmans/base/html/subset.html) | Subsets of object by conditions |
| [`suppressWarnings`](https://search.r-project.org/R/refmans/base/html/warning.html) | Suppress warning messages |
| [`Surv`](https://search.r-project.org/CRAN/refmans/survival/html/Surv.html) | Survival, i.e., time-to-event, object, from package **`survival`** [@survival] |
| [`table`](https://search.r-project.org/R/refmans/base/html/table.html) | Cross tabulation |
| [`update`](https://search.r-project.org/R/refmans/stats/html/update.html) | Update and re-fit a model call |

# References

::: {#refs}
:::
